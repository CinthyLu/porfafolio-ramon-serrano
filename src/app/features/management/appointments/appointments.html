<div class="appointments-wrapper">

  <div class="appointments-card">

    <div class="header-section">
      <h2 class="title">Solicitudes de AsesorÃ­a</h2>
      <div class="header-actions">
        <button class="btn-availability" routerLink="/availability">
          ðŸ“… Gestionar Disponibilidad
        </button>
      </div>
    </div>

    <!-- Notifications -->
    <div class="notification" *ngIf="notification.visible" [ngClass]="notification.type">
      {{ notification.message }}
    </div>

    <!-- Filter -->
    <div class="filter-bar">
      <label>Estado:</label>
      <select [(ngModel)]="filterStatus" (change)="loadAdvisories()">
        <option value="all">Todas</option>
        <option value="PENDING">Pendientes</option>
        <option value="APPROVED">Aprobadas</option>
        <option value="REJECTED">Rechazadas</option>
        <option value="COMPLETED">Completadas</option>
      </select>

      <div class="export-buttons">
        <button class="btn-secondary" (click)="downloadReport('pdf')">ðŸ“„ PDF</button>
        <button class="btn-secondary" (click)="downloadReport('excel')">ðŸ“Š Excel</button>
      </div>
    </div>

    <!-- LOADING -->
    <div *ngIf="loading" class="loading-wrapper">
      <div class="spinner"></div>
      <p>Cargando solicitudes...</p>
    </div>

    <!-- TABLA CON DATOS -->
    <table class="styled-table" *ngIf="!loading && advisories.length > 0">
      <thead>
        <tr>
          <th>Solicitante</th>
          <th>Fecha y Hora</th>
          <th>Comentario</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let a of getFilteredAdvisories()" (click)="selectAdvisory(a)" [class.selected]="isSelected(a)">
          <td class="email-cell">{{ a.externalName || a.externalId || 'AnÃ³nimo' }}</td>

          <td>{{ a.scheduledAt | date : 'dd/MM/yyyy HH:mm' }}</td>

          <td class="comment">{{ a.requestComment || 'â€”' }}</td>

          <td>
            <span class="status-badge" [ngClass]="getStatusColor(a.status)">
              {{ getStatusLabel(a.status) }}
            </span>
          </td>

          <td class="actions">
            <button *ngIf="a.status === 'PENDING'" class="btn-approve" (click)="approve(a); $event.stopPropagation()">
              âœ“ Aprobar
            </button>

            <button *ngIf="a.status === 'PENDING'" class="btn-reject" (click)="reject(a); $event.stopPropagation()">
              âœ— Rechazar
            </button>

            <button *ngIf="a.status === 'APPROVED'" class="btn-approve" (click)="complete(a); $event.stopPropagation()">
              âœ“ Completar
            </button>

            <span *ngIf="a.responseMessage" class="response-msg">
              {{ a.responseMessage }}
            </span>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Response Message Input -->
    <div *ngIf="selectedAdvisory && selectedAdvisory.status === 'PENDING'" class="response-form">
      <label>Mensaje de respuesta (opcional):</label>
      <textarea [(ngModel)]="responseMessage" placeholder="Mensaje para el solicitante..."></textarea>
    </div>

    <!-- EMPTY STATE -->
    <div *ngIf="!loading && advisories.length === 0" class="empty-state">
      No tienes solicitudes por ahora.
    </div>

    <div class="footer">
      <button class="btn-secondary" routerLink="/">Volver</button>
    </div>

  </div>
</div>